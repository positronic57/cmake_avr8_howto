## „Накрсно преведување“ за AVR8 микроуправувачи со CMake и AVR-GCC

Под поимот накрсно-преведување (во оригинал на англиски: Cross-compilling) се подразбира постапка во која програмски код напишан за една хардверска платформа се преведува за извршување на друга платформа со користење на преведувач способен да генерира извршен код за целниот хардвер. Резулатот од преводот ќе може да се изврши само на хардвеорт за кој е наменет, но не и на хардверот на кој што е направено преведувањето. Оваа кратко упатство се однесува за накрсно преведување на C/C++ програми за Microchip AVR8 микроуправувачи со користење на avr-gcc преведувач на Linux PC.
    
За накрсно преведување на C/C++ проект за Microchip AVR8 платформа со помош на CMake и avr-gcc потребни се три состојки:
 - ланец од алатки (оригинално: tool chain) за целната платформа, достапни на платформата домаќин на преведувањето. Во овој случај станува збор за avr-gcc преведувач за C/C++ код, avr-libc библиотека и придружни алатки за создавање и работа со бинарни фајлови за Microchip AVR8 мокроуправувачи. Како домаќин на преведувачкиот процес ќе послужи компјутер со Ubuntu оперативен систем, но тоа може да биде било кој друг Linux систем. 
 - CMake конфигурациски фајл *CMakeLists.txt*, кој го опишува преведувачкиот процес и му кажува на CMake како да ги создаде фајловите со правилата за превод;
 - *CMake "tool chain file".*

### Ланец од алатки за превод на C/C++ код

Кај Ubuntu оперативен систем како домаќин на преведувањето, ланецот од алатки за Microchip AVR8 e достапен во стандардните складишта за софтверски пакети. Станува збор за пакетите: avr-libc, binutils-avr and gcc-avr, кои на Ubuntu оперативен систем се инсталираат со наредбата:
```
#sudo apt install avr-libc binutils-avr gcc-avr
```

### CMake конфигурациски фајл за ланец со алатки

Овој фајл му кажува на CMake сe што треба да знае за целната платформа на која ќе треба да се извршува преводот, за да може да го подготви преведувањето [^1]; ги дефинира преведувачите за C/C++ код од ланецот на алатки за AVR8 архитектура. 
Во овој пример, фајот е наречен: avr8_toolchain.cmake.
Microchip AVR8 микроуправувачите немаат инсталиран оперативен систем кој подржува вчитување на дополнителни библиотеки при извршување на програми. Тоа е битен податок кој CMake мора да го знае при подготовката на преведувањето. За таа цел, во конфигурацискиот фајл за ланец со алатки се наведува конфигурациската поставка CMAKE_SYSTEM_NAME со врдност: **_Generic_**[^1]. 
```
set(CMAKE_SYSTEM_NAME Generic)
```
Следни битни конфигурациски поставки се оние кои го дефинираат C и C++ копајлерот, преку наведување на апсолутната патека до нивните извршни датотеки:
```
set(CMAKE_C_COMPILER /usr/bin/avr-gcc)
set(CMAKE_CXX_COMPILER /usr/bin/avr-g++)
```
Преводот на AVR8 код бара користење на опции за предедувачот кои се разликуваат од оние кои што се наведени при превод на код со gcc преведувач, кога целната платформа е системот домаќин. И овие опции се дел од конфигурацискиот фајл за ланецот со алатки преку поставките:
```
#Define the compiler flags for AVR8 platform
set(FLAGS "-Wall -Os -fpack-struct -fshort-enums -ffunction-sections -fdata-sections -std=gnu99 -funsigned-char -funsigned-bitfields")

#Clear all the default flags set by CMake
unset(CMAKE_C_FLAGS CACHE)
unset(CMAKE_CXX_FLAGS CACHE)

#Apply the wanted flags for AVR8
set(CMAKE_CXX_FLAGS ${FLAGS} CACHE STRING "" FORCE)
set(CMAKE_C_FLAGS ${FLAGS} CACHE STRING "" FORCE)
```

### CMakeLists.txt фајл со насоки за преведување на извиорнито код

Станува збор за стандарден CMake конфигурациски фајл кој по ништо не се разликува од истиот таков фајл за превод на C/C++ код на PC платформа со gcc/g++ преведувач. 

#### Firmware фајл во Intel HEX формат

Резулутатот од преводот е firmware фајл во ELF формат. Овој формат не е поддржан од AVR8 миктоконтролери и како таков не може да се вчита/запише во микроуправувачот за негово извршување, туку мора првин да се преобрази во Intel HEX формат. За таа цел, во _CMakeLists.txt_ фајлот е дефиниран дополнителен чекор кој ќе се изврши автоматски по успешниот превод на кодот и ќе направи неопходната преобразба. Ново добиениот фајл е firmware-от кој може да се запише во FLASH меморијата на микроуправувачот со помош на алатката avrdude и соодветен програматор.
```
add_custom_command(
    TARGET ${PROJECT_NAME}.elf
    POST_BUILD
    COMMAND avr-objcopy -j .text -j .data -O ihex ${PROJECT_NAME}.elf ${PROJECT_NAME}.hex 
)
```

#### Дополнителни CMake аргументи 

Во CMakeLists.txt се дефинирани два аргументи кои служат за проследување на подолнителни информации до CMake и тоа:
 - __MCU__ - ја дефинира вредноста на __-mmcu__ аргументот при повик на avr-gcc. Со него се наведува моделот на целниот микроуправувач за да може преведувачот да генерира соодветен код. Иако сите AVR8 микроуправувачи имаат иста харверска архитетура не сите микроуправувачи имаат иста хардверска конфигурација. Доколку не е наведен, подразбирливата вредност за овој аргумент е: "atmega32"([комплетна листа од поддржани вредности на -mmcu](https://onlinedocs.microchip.com/pr/GUID-317042D4-BCCE-4065-BB05-AC4312DBC2C4-en-US-2/index.html)).
 - __CPU_FREQ__ - работна фрекфенција на микроуправувачот. Неговата вредност е неопходна за превод на некои функции од avr-lib библиотеката, како на пример оние за временско доцнење. Подразбирлива вредност: 16MHz.
  
## Превод на C/C++ проект со помош на CMake

Креирај засебна папка за превод на кодот во папката на проектот:
```
#mkdir build && cd build
```
Креирај ги фајловите со наредби за превод на кодот со помош на CMake:
```
#cmake -DCMAKE_TOOLCHAIN_FILE=../avr8_toolchain.cmake -DMCU=attiny2313 -DCPU_FREQ=20000000L ..
```
Во овој случај, кодот ќе биде преведен за ATtiny2313 микроуправувач со работна фрекфенција од 20МHz. Направи го преводот на кодот со:
```
#make
```
Како резултат на преводот, во build папката ќе бидат креирани два бинарни фајлови: .elf и firmware фајл со наставка .hex.

### ПРЕДУПРЕДУВАЊЕ:
Изворниот код е достапен каков што е, без никаква гаранција за неговата функционалност и содржина. Користете го на сопствен ризик!
Авторот на кодот не презема никава одговорност за штети кои можеби би биле предизвикани со користење на овој код.

### ОГРАДУВАЊЕ: 
Изворниот кодот е резултат на хоби дејност и авторот не е поврзан ниту пак е во партнерство со некој од прозводителите на уреди/софтверски алатки спомнати во кодот, документацијата или описот на овој проект. Авторот не искажува никаква поврзаност со, претензија или сопственост врз трговските имиња наведени во проектот. Сите трговски имиња и заштитни знаци се во сопсвеност на нивните иматели.


[^1]: [Cross Compiling With CMake](https://cmake.org/cmake/help/book/mastering-cmake/chapter/Cross%20Compiling%20With%20CMake.html)